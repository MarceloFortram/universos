<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Simulador de Universos ‚Äî Vida (Carbono & Alternativas) + Heatmap Œ±√óG + Friedmann</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<meta name="description" content="Simulador educacional de universos: vida baseada em carbono e alternativas, heatmap Œ±√óG, mol√©culas essenciais, cosmologia com Friedmann e estimativa de quando surgem planetas rochosos, Terra-like e vida.">
<style>
  :root{
    --bg:#0f1117; --fg:#e6e6eb; --muted:#9aa0a6;
    --card:#151924; --border:#2a2f3b;
    --blue:#6c90ff; --red:#ff6b6b; --green:#10b981; --amber:#f59e0b; --violet:#a78bfa;
  }
  [data-theme="light"]{
    --bg:#f7f8fb; --fg:#14161c; --muted:#4b5563;
    --card:#ffffff; --border:#e5e7eb;
    --blue:#3853d8; --red:#d43f3f; --green:#0c8d6a; --amber:#b27208; --violet:#6b46c1;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--border);padding:.9rem 1rem;display:flex;gap:.75rem;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:clamp(1rem,2.4vw,1.25rem)}
  nav a{color:var(--fg);text-decoration:none}
  .btn{border:1px solid var(--border);background:transparent;color:var(--fg);padding:.5rem .8rem;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
  .btn:active{transform:translateY(1px)}
  main{max-width:1250px;margin:1rem auto;padding:0 1rem}
  .grid{display:grid;gap:1rem;grid-template-columns:1fr}
  @media (min-width:1024px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem}
  .legend{font-weight:700;margin-bottom:.6rem;display:flex;gap:.5rem;align-items:center}
  .muted{color:var(--muted);font-size:.9rem}
  .split{display:grid;gap:.75rem;grid-template-columns:1fr}
  @media (min-width:640px){ .split{grid-template-columns:1fr 1fr} }
  label{display:flex;justify-content:space-between;align-items:center;gap:.75rem;margin:.45rem 0}
  input[type="number"], select{
    width:140px;padding:.45rem .6rem;border-radius:10px;border:1px solid var(--border);
    background:transparent;color:var(--fg)
  }
  .row{display:flex;flex-wrap:wrap;gap:.5rem}
  .pill{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--border);padding:.25rem .55rem;border-radius:999px}
  .ok{background:color-mix(in srgb,var(--green) 22%, transparent)}
  .warn{background:color-mix(in srgb,var(--amber) 22%, transparent)}
  .bad{background:color-mix(in srgb,var(--red) 22%, transparent)}
  .box{display:grid;grid-template-columns:auto 1fr;gap:.3rem .75rem;font-size:.92rem}
  .k{color:var(--muted)}
  canvas{background:var(--card);border:1px solid var(--border);border-radius:14px}
  .title{font-weight:700;margin:.2rem 0 .6rem}
  .hr{height:1px;background:var(--border);margin:.6rem 0}
  .notice{font-size:.85rem;border-left:3px solid var(--violet);padding:.5rem .75rem;background:color-mix(in srgb,var(--violet) 12%, transparent);border-radius:8px}
  .molecules{display:flex;flex-wrap:wrap;gap:.4rem}
  .mol{border:1px solid var(--border);border-radius:10px;padding:.35rem .55rem;font-size:.9rem}
  .mol.ok{background:color-mix(in srgb,var(--green) 18%, transparent)}
  .mol.mid{background:color-mix(in srgb,var(--amber) 18%, transparent)}
  .mol.bad{background:color-mix(in srgb,var(--red) 18%, transparent)}
  .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;margin:.5rem 0}
  .small{font-size:.85rem}
  footer{max-width:1250px;margin:2rem auto 1.5rem;padding:0 1rem;color:var(--muted)}
  footer .about{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem}
</style>
</head>
<body>
<header>
  <h1>Simulador de Universos ‚Äî Vida: Carbono & Alternativas</h1>
  <nav class="row">
    <a class="btn" href="README.md" target="_blank" rel="noopener">üìò Tutorial (README)</a>
    <a class="btn" href="https://github.com/MarceloFortram/universos" target="_blank" rel="noopener">üß≠ Reposit√≥rio</a>
    <a class="btn" href="index_eng.html" rel="noopener">üåç English</a>
    <button id="btnTheme" class="btn" type="button">üåó Tema</button>
    <button id="btnShare" class="btn" type="button">üîó Compartilhar</button>
    <button id="btnRun" class="btn primary" type="button">‚ñ∂Ô∏è Avaliar</button>
  </nav>
</header>

<main>
  <!-- (1) CONSTANTES -->
  <section class="grid">
    <div class="card">
      <div class="legend">1) Constantes fundamentais (ajuste fino)</div>
      <div class="split">
        <div>
          <label title="Constante de estrutura fina (Œ± ‚âà 1/137)">
            <span>Œ± (estrutura fina)</span>
            <input id="alpha" type="number" step="0.00001" value="0.007297" />
          </label>
          <label title="Raz√£o massa el√©tron / pr√≥ton (‚âà 1/1836)">
            <span>Œº = m‚Çë/m‚Çö</span>
            <input id="mu" type="number" step="0.00001" value="0.0005446" />
          </label>
          <label title="Diferen√ßa de massa n√™utron-pr√≥ton (MeV) ‚âà 1.293">
            <span>Œî(m‚Çô‚àím‚Çö) [MeV]</span>
            <input id="dMnp" type="number" step="0.001" value="1.293" />
          </label>
          <label title="Escala efetiva da for√ßa forte (1 = nossa)">
            <span>For√ßa forte (x)</span>
            <input id="strong" type="number" step="0.01" value="1.00" />
          </label>
          <label title="Escala efetiva da gravidade (1 = nossa)">
            <span>Gravidade G (x)</span>
            <input id="Gscale" type="number" step="0.01" value="1.00" />
          </label>
        </div>
        <div>
          <label title="Probabilidade de varia√ß√£o aleat√≥ria aplicada nas entradas">
            <span>Acaso (ru√≠do) %</span>
            <input id="rng" type="number" step="1" value="0" />
          </label>
          <label title="Puxa valores para a faixa habit√°vel (metapar√°metro educacional)">
            <span>Direcionamento (‚ÄúDeus‚Äù) %</span>
            <input id="bias" type="number" step="1" value="0" />
          </label>
          <label title="Qu√£o estreitas s√£o as janelas de ajuste fino (0 = tolerante, 1 = muito estrito)">
            <span>Sensibilidade (0‚Äì1)</span>
            <input id="tight" type="number" step="0.05" value="0.7" />
          </label>
          <div class="notice">
            Estas janelas s√£o <b>heur√≠sticas plaus√≠veis</b> para ensino. N√£o substituem qu√≠mica qu√¢ntica real.
          </div>
        </div>
      </div>
    </div>

    <!-- (2) COSMOLOGIA + FRIEDMANN -->
    <div class="card">
      <div class="legend">2) Cosmologia m√≠nima + Friedmann</div>
      <div class="split">
        <div>
          <label><span>Œ©m (mat√©ria)</span><input id="Om" type="number" step="0.01" value="0.30"/></label>
          <label><span>Œ©r (radia√ß√£o)</span><input id="Or" type="number" step="0.0001" value="0.0001"/></label>
          <label><span>Œ©Œõ (energia escura)</span><input id="OL" type="number" step="0.01" value="0.70"/></label>
          <label><span>H‚ÇÄ (km/s/Mpc)</span><input id="H0" type="number" step="1" value="70"/></label>
        </div>
        <div>
          <label title="Tempo efetivo √∫til para qu√≠mica/evolu√ß√£o">
            <span>Tempo dispon√≠vel (Gyr)</span>
            <input id="age" type="number" step="0.5" value="14"/>
          </label>
          <div class="box" style="margin-top:.4rem">
            <div class="k">Œ©k (curvatura)</div><div id="okShow">‚Äî</div>
            <div class="k">Checagens cosmol√≥gicas</div><div id="cosmoChk">‚Äî</div>
            <div class="k">t(rad=mat)</div><div id="tRM">‚Äî</div>
            <div class="k">t(Œõ domina)</div><div id="tML">‚Äî</div>
            <div class="k">Janela estruturas</div><div id="tWin">‚Äî</div>
            <div class="k">‚è±Ô∏è 1¬∫ rochosos</div><div id="tRock">‚Äî</div>
            <div class="k">üåç Terra-like</div><div id="tEarth">‚Äî</div>
            <div class="k">üß¨ Vida plaus√≠vel</div><div id="tLife">‚Äî</div>
          </div>
          <div class="muted small" style="margin-top:.4rem">
            Integra√ß√£o RK4 de Friedmann: \( \dot a = a H(a) \), com \( H(a)=H_0\sqrt{\Omega_r a^{-4}+\Omega_m a^{-3}+\Omega_k a^{-2}+\Omega_\Lambda} \ ).
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- (3) AMBIENTE -->
  <section class="grid">
    <div class="card">
      <div class="legend">3) Ambiente planet√°rio</div>
      <div class="split">
        <div>
          <label><span>Temperatura superficial (K)</span><input id="T" type="number" step="1" value="288"/></label>
          <label><span>Press√£o superficial (bar)</span><input id="P" type="number" step="0.01" value="1.0"/></label>
          <label>
            <span>Solvente principal</span>
            <select id="solvent">
              <option value="H2O">√Ågua (H‚ÇÇO)</option>
              <option value="NH3">Am√¥nia (NH‚ÇÉ)</option>
              <option value="CH4">Metano (CH‚ÇÑ)</option>
              <option value="C2H6">Etano (C‚ÇÇH‚ÇÜ)</option>
              <option value="CO2sc">CO‚ÇÇ supercr√≠tico</option>
            </select>
          </label>
          <label title="Radia√ß√£o estelar ionizante relativa (1 = Terra)">
            <span>Ambiente UV/X (x)</span><input id="uv" type="number" step="0.1" value="1.0"/>
          </label>
        </div>
        <div>
          <div class="title">Janelas de l√≠quido (1 bar, refer√™ncia):</div>
          <div class="box">
            <div class="k">√Ågua</div><div>273‚Äì373 K</div>
            <div class="k">Am√¥nia</div><div>195‚Äì240 K</div>
            <div class="k">Metano</div><div> 90‚Äì112 K</div>
            <div class="k">Etano</div><div> 90‚Äì185 K</div>
            <div class="k">CO‚ÇÇ (supercr√≠tico)</div><div> T‚â•304 K & P‚â•73 bar</div>
          </div>
          <div class="muted small" style="margin-top:.4rem">
            Faixas mudam com press√£o; UV alto quebra mol√©culas fr√°geis (penalizado).
          </div>
        </div>
      </div>
    </div>

    <!-- (4) RESULTADO -->
    <div class="card">
      <div class="legend">4) Resultado & Diagn√≥stico</div>
      <div class="row" style="margin-bottom:.5rem">
        <span id="lifeC" class="pill">Carbono: ‚Äî</span>
        <span id="lifeAlt" class="pill">Vida alternativa: ‚Äî</span>
      </div>
      <div class="box" id="diag"></div>
      <div class="hr"></div>
      <div class="title">Componentes (0‚Äì100)</div>
      <div style="position:relative;height:320px">
        <canvas id="chartComponents"></canvas>
      </div>
      <div class="muted" style="margin-top:.5rem">
        Subscores: Qu√≠mica/√Åtomos, Estrelas (G), Cosmologia (com Friedmann), Solvente/UV.
      </div>
    </div>
  </section>

  <!-- (5) MOL√âCULAS + (6) a(t) -->
  <section class="grid" style="margin-top:1rem">
    <div class="card">
      <div class="legend">5) Mol√©culas essenciais</div>
      <div id="molecules" class="molecules"></div>
      <div class="muted small" style="margin-top:.5rem">
        Avalia√ß√µes qualitativas via heur√≠sticas (liga√ß√£o/produ√ß√£o de elementos e ambiente). Educacional.
      </div>
    </div>

    <div class="card">
      <div class="legend">6) Cosmologia detalhada ‚Äî a(t) com marcadores</div>
      <div style="position:relative;height:340px">
        <canvas id="chartAT"></canvas>
      </div>
      <div class="muted small" style="margin-top:.5rem">
        Linhas verticais: ‚è±Ô∏è primeiros rochosos ‚Ä¢ üåç Terra-like ‚Ä¢ üß¨ vida plaus√≠vel (apenas se vi√°veis). Textos ficam na legenda.
      </div>
    </div>
  </section>

  <!-- (7) HEATMAP -->
  <section class="card" style="margin-top:1rem">
    <div class="legend">7) Mapa de calor Œ±√óG ‚Äî Zonas habit√°veis</div>
    <div class="toolbar">
      <label class="small"><span style="margin-right:.4rem">Resolu√ß√£o</span>
        <input id="res" type="number" step="5" min="10" max="120" value="50" />
      </label>
      <label class="small"><span style="margin-right:.4rem">Modo</span>
        <select id="mapMode">
          <option value="carbon">Carbono</option>
          <option value="alt">Vida alternativa</option>
        </select>
      </label>
      <button id="btnHeat" type="button" class="btn">üó∫Ô∏è Gerar mapa</button>
      <div class="muted small">Clique/toque no mapa para aplicar Œ± e G.</div>
    </div>
    <div style="position:relative; height:380px">
      <canvas id="heat" style="width:100%;height:100%;border-radius:12px;border:1px solid var(--border)"></canvas>
      <div id="heatInfo" class="pill" style="position:absolute;left:10px;top:10px">Œ±=‚Äî ‚Ä¢ G=‚Äî ‚Ä¢ score=‚Äî</div>
    </div>
    <div class="muted small" style="margin-top:.5rem">
      Eixo X: Œ± (0,005 ‚Üí 0,010). Eixo Y: G (0,3 ‚Üí 2,0). Verde = melhor, vermelho = pior.
    </div>
  </section>
</main>

<footer>
  <div class="about">
    <b>Sobre o Autor ‚Äî Marcelo Fortran</b><br/>
    Marcelo Fortran √© <i>entusiasta de programa√ß√£o</i> e <i>curioso de ci√™ncia</i>. Este projeto nasce do interesse em tornar
    ideias de cosmologia, qu√≠mica e habitabilidade acess√≠veis ao p√∫blico geral por meio de um simulador interativo no navegador.
  </div>
  <div style="margin-top:.6rem">
    üìò Leia o tutorial completo em <a href="README.md">README.md</a> ‚Ä¢ üåç English version: <a href="index_eng.html">index_eng.html</a>
  </div>
</footer>

<script>
/* ========= Tema ========= */
(function(){
  const root = document.documentElement;
  const saved = localStorage.getItem('theme') || 'dark';
  root.setAttribute('data-theme', saved);
  document.getElementById('btnTheme').addEventListener('click', ()=>{
    const now = root.getAttribute('data-theme')==='dark'?'light':'dark';
    root.setAttribute('data-theme', now);
    localStorage.setItem('theme', now);
  });
})();

/* ========= Helpers ========= */
const $ = s=>document.querySelector(s);
function readFlo(id){ return parseFloat($(id).value); }
function setTxt(id, txt){ $(id).textContent = txt; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function rnd(){ return Math.random()*2-1; }
function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

/* ========= Acaso & Direcionamento ========= */
function nudge(value, target, noisePct, biasPct){
  const v = value*(1 + (noisePct/100)*rnd());
  const b = value + (biasPct/100)*(target - value);
  return (noisePct>0 || biasPct>0) ? (0.5*v + 0.5*b) : value;
}

/* ========= Janelas (nome n√£o conflita com window) ========= */
function winRange(val, center, relSpan, tight){
  const span = relSpan * (1 - 0.6*tight);
  const lo = center*(1-span), hi = center*(1+span);
  if(val<lo || val>hi) return 0;
  const d = Math.abs((val-center)/(center*span));
  return clamp(1 - d*d, 0, 1);
}

/* ========= Cosmologia por Friedmann ========= */
function integrateFriedmann(H0, Om, Or, OL, ageGyr, steps=800){
  const Ok = 1 - (Om+Or+OL);
  const H0_Gyr = H0/978; // ~0.0716 Gyr^-1 para H0=70
  function H_of_a(a){
    const arg = Or/(a**4) + Om/(a**3) + Ok/(a**2) + OL;
    return H0_Gyr * Math.max(0, Math.sqrt(Math.max(0,arg)));
  }
  const dt = ageGyr/steps;
  let a = 1e-4, t=0;
  const T=new Array(steps+1), A=new Array(steps+1);
  for(let i=0;i<=steps;i++){
    T[i]=t; A[i]=a;
    const k1 = H_of_a(a)*a*dt;
    const k2 = H_of_a(a + k1/2)* (a + k1/2) * dt;
    const k3 = H_of_a(a + k2/2)* (a + k2/2) * dt;
    const k4 = H_of_a(a + k3)*   (a + k3)   * dt;
    const da = (k1 + 2*k2 + 2*k3 + k4)/6;
    a = (da>0 && isFinite(da)) ? a + da : a;
    t += dt;
  }
  const norm = A[A.length-1] || 1;
  for(let i=0;i<A.length;i++){ A[i] = A[i]/norm; }
  return {t:T, a:A, Ok};
}
function findTimeAtA(T, A, aTarget){
  if(aTarget==null || aTarget<=0) return null;
  for(let i=1;i<A.length;i++){
    if(A[i-1]<=aTarget && A[i]>=aTarget){
      const u=(aTarget-A[i-1])/(A[i]-A[i-1] + 1e-12);
      return T[i-1]+u*(T[i]-T[i-1]);
    }
  }
  return null;
}

/* ========= Cosmologia m√≠nima (checks est√°ticos) ========= */
function cosmosChecksStatic(Om, Or, OL, ageGyr){
  const Ok = 1 - (Om+Or+OL);
  const hasMatter = Om >= 0.05 ? 1 : 0;
  const lambdaNotTooHigh = OL <= 0.9 ? 1 : 0;
  const ageOK = ageGyr >= 5 ? 1 : 0;
  const score = (hasMatter + lambdaNotTooHigh + ageOK)/3;
  const notes = [];
  if(!hasMatter) notes.push("Mat√©ria insuficiente para formar gal√°xias.");
  if(!lambdaNotTooHigh) notes.push("Energia escura muito alta: estruturas cortadas cedo.");
  if(!ageOK) notes.push("Tempo dispon√≠vel muito curto (<5 Gyr).");
  return {Ok, score, notes};
}

/* ========= Qu√≠mica at√¥mico-nuclear ========= */
function atomicChemScores(alpha, mu, dMnpMeV, strongScale, tight){
  const alpha0 = 1/137.035999;
  const mu0 = 1/1836.152673;
  const dM0 = 1.293;
  const s0 = 1.0;

  const sAlpha = winRange(alpha, alpha0, 0.18, tight);
  const sMu    = winRange(mu,    mu0,    0.35, tight);
  const sDM    = winRange(dMnpMeV, dM0,  0.45, tight);
  const sStrong= winRange(strongScale, s0, 0.05, tight);

  const notes=[];
  if(sAlpha===0) notes.push("Œ± fora do intervalo: liga√ß√µes eletr√¥nicas inst√°veis.");
  if(sMu===0) notes.push("m‚Çë/m‚Çö fora do intervalo: orbitais/qu√≠mica alteradas demais.");
  if(sDM===0) notes.push("Œî(m‚Çô‚àím‚Çö) fora do intervalo: estabilidade nuclear comprometida.");
  if(sStrong===0) notes.push("For√ßa forte fora do ajuste fino: carbono/oxig√™nio suprimidos.");

  const atomScore = 0.35*sAlpha + 0.25*sMu + 0.25*sDM + 0.15*sStrong;
  const carbonOK = (sStrong>0.25);

  return { atomScore, carbonOK, notes, pieces:{sAlpha,sMu,sDM,sStrong} };
}

/* ========= Estrelas (gravidade) ========= */
function stellarScore(Gscale, tight){
  const sG = winRange(Gscale, 1.0, 0.5, tight);
  const notes=[];
  if(sG===0 && Gscale>1.0) notes.push("G alto: estrelas vivem pouco (milh√µes de anos).");
  if(sG===0 && Gscale<1.0) notes.push("G baixo: igni√ß√£o nuclear dificultada.");
  return { sG, notes };
}

/* ========= Solventes & UV ========= */
function solventWindow(solvent, T, P){
  let ok=0, msg=""; 
  if(solvent==='H2O'){ ok = (T>=273 && T<=373 && P>=0.006) ? 1:0; msg="√Ågua l√≠quida 273‚Äì373 K @ ‚â•0.006 bar"; }
  if(solvent==='NH3'){ ok = (T>=195 && T<=240) ? 1:0; msg="Am√¥nia l√≠quida 195‚Äì240 K @ ~1 bar"; }
  if(solvent==='CH4'){ ok = (T>=90 && T<=112)  ? 1:0; msg="Metano l√≠quido 90‚Äì112 K @ ~1 bar"; }
  if(solvent==='C2H6'){ ok = (T>=90 && T<=185) ? 1:0; msg="Etano l√≠quido 90‚Äì185 K @ ~1 bar"; }
  if(solvent==='CO2sc'){ ok = (T>=304 && P>=73) ? 1:0; msg="CO‚ÇÇ supercr√≠tico T‚â•304 K & P‚â•73 bar"; }
  return {ok, msg, solvent};
}
function uvPenalty(uv){
  const p = 1/(1+Math.exp(-(2-uv)));
  return clamp(1.2 - 0.2*p, 0.6, 1);
}

/* ========= Mol√©culas Essenciais (heur√≠stico) ========= */
function moleculesAssessment(alpha, mu, strongScale, envOK, tight){
  const alpha0 = 1/137.035999, mu0 = 1/1836.152673;
  const eScale = (alpha/alpha0)**2 * (mu/mu0);
  const prodCO = winRange(strongScale, 1.0, 0.05, tight);
  const prodN  = winRange(strongScale, 1.0, 0.08, tight);
  function status(score){ if(score>=0.75) return {cls:'ok', txt:'est√°vel'}; if(score>=0.4) return {cls:'mid', txt:'marginal'}; return {cls:'bad', txt:'inst√°vel'}; }
  const eH2 = 13.6 * eScale;
  const sH2 = clamp( (eH2>5 && eH2<25) ? 0.9 : (eH2>3 && eH2<35 ? 0.5 : 0.0), 0, 1);
  const sCH4 = clamp(0.6*prodCO + 0.4*winRange(eScale, 1.0, 0.7, tight), 0, 1);
  let sH2O = clamp(0.6*prodCO + 0.4*sH2, 0, 1);
  if(envOK && envOK.solvent==='H2O' && envOK.ok) sH2O = clamp(sH2O*1.05, 0, 1);
  const sNH3 = clamp(0.6*prodN + 0.4*sH2, 0, 1);
  const sCO2 = prodCO;
  return {
    H2:  {score:sH2,  ...status(sH2)},
    H2O: {score:sH2O, ...status(sH2O)},
    CH4: {score:sCH4, ...status(sCH4)},
    NH3: {score:sNH3, ...status(sNH3)},
    CO2: {score:sCO2, ...status(sCO2)},
  };
}

/* ========= Estimativas de tempos (rochosos, Terra-like, vida) ========= */
function estimateTimes(params, cosmo, atc, st, env, cosScore){
  const age = params.age;
  const t_rm = cosmo.t_rm ?? 0;
  const t_mL = cosmo.t_mL ?? (0.75*age);
  const t_struct = Math.max(0, (t_mL - t_rm));

  const metalsOK = atc.carbonOK && atc.atomScore >= 0.35;
  const starsOK  = st.sG > 0.15;
  const cosmosOK = cosScore >= 0.35;

  if(!metalsOK || !starsOK || !cosmosOK){
    return {
      rockyPossible:false, earthLikePossible:false, lifePossible:false,
      tFirstRocky:null, tEarthLike:null, tLife:null,
      reason: (!metalsOK ? "Metais-chave (C/O) suprimidos." :
              !starsOK ? "Estrelas pouco vi√°veis (G fora da janela)." :
              "Cosmologia limita estruturas/tempo.")
    };
  }

  // Primeiros rochosos ‚Äî fra√ß√£o da janela estrutural + leve ajuste por G
  const fracBase = 0.18;
  const gShift = clamp(-0.12*(params.Gscale-1), -0.25, 0.25);
  const frac = clamp(fracBase + gShift, 0.05, 0.45);
  let tFirstRocky = t_rm + frac * (t_struct>0 ? t_struct : 0.6*age);
  if(params.OL>0.85) tFirstRocky = Math.min(tFirstRocky, t_mL + 1);
  tFirstRocky = Math.max(tFirstRocky, t_rm + 0.05);

  // Terra-like ‚Äî janela t√≠pica para metallicidade alta + estrelas est√°veis
  const delayScale = Math.pow(age/13.8, 0.9);
  let tauEarth = 4.6 * delayScale * Math.pow(params.Gscale, -0.15);
  if(params.OL>0.85) tauEarth *= 0.8;
  let tEarthLike = Math.max(age - tauEarth, tFirstRocky + 0.5);
  if(params.OL>0.9) tEarthLike = Math.min(tEarthLike, t_mL + 1.5);

  // Vida plaus√≠vel ‚Äî depende do solvente, UV e exige solvente l√≠quido
  const solventOK = env.ok;
  let tauBio = 1.0;
  switch(params.solvent){
    case 'H2O':  tauBio = 0.6 * Math.max(1, params.uv/1.5); break;
    case 'NH3':  tauBio = 1.5 * Math.max(1, params.uv/1.2); break;
    case 'CH4':  tauBio = 3.0 * Math.max(1, params.uv/1.0); break;
    case 'C2H6': tauBio = 2.5 * Math.max(1, params.uv/1.0); break;
    case 'CO2sc':tauBio = 1.0 * Math.max(1, params.uv/1.3); break;
  }
  if(params.uv>3) tauBio += 0.5;
  let tLife = tEarthLike + tauBio;

  const rockyPossible = isFinite(tFirstRocky) && (tFirstRocky < age);
  const earthLikePossible = rockyPossible && isFinite(tEarthLike) && (tEarthLike < age);
  const lifePossible = earthLikePossible && solventOK && isFinite(tLife) && (tLife < age);

  if(!solventOK) return {rockyPossible, earthLikePossible, lifePossible:false, tFirstRocky, tEarthLike, tLife:null, reason:"Solvente fora da faixa l√≠quida."};

  return {rockyPossible, earthLikePossible, lifePossible, tFirstRocky, tEarthLike, tLife, reason:null};
}

/* ========= Agrega√ß√£o (com Friedmann) ========= */
function evaluateAll(params){
  const {alpha, mu, dMnp, strong, Gscale, Om, Or, OL, age, T, P, solvent, uv, tight} = params;

  const cosStatic = cosmosChecksStatic(Om,Or,OL,age);
  const integ = integrateFriedmann(readFlo('#H0'), Om, Or, OL, age, 800);

  const a_rm = (Or>0 && Om>0)? (Or/Om) : null;
  const a_mL = (OL>0 && Om>0)? Math.pow(Om/OL, 1/3) : null;
  const t_rm = findTimeAtA(integ.t, integ.a, a_rm);
  const t_mL = findTimeAtA(integ.t, integ.a, a_mL);
  const tWin = (t_rm!=null && t_mL!=null && t_mL>t_rm) ? (t_mL - t_rm) : null;

  const fracWin = tWin ? clamp(tWin/age, 0, 1) : 0;
  const cosScore = clamp(0.55*cosStatic.score + 0.45*fracWin, 0, 1);

  const atc = atomicChemScores(alpha, mu, dMnp, strong, tight);
  const st  = stellarScore(Gscale, tight);
  const env = solventWindow(solvent, T, P);
  const uvk = uvPenalty(uv);

  const S_atoms   = Math.round(100*atc.atomScore);
  const S_stars   = Math.round(100*st.sG);
  const S_cosmos  = Math.round(100*cosScore);
  const S_solvent = Math.round(100*(env.ok?1:0)*uvk);

  let carbonScore = 0.35*S_atoms + 0.18*S_stars + 0.27*S_cosmos + 0.20*(solvent==='H2O'?S_solvent:0);
  if(!atc.carbonOK) carbonScore = Math.min(carbonScore, 35);
  carbonScore = Math.round(clamp(carbonScore, 0, 100));

  const altSolvOK = (solvent!=='H2O' && env.ok);
  const alpha0 = 1/137.035999;
  const alphaDev = Math.abs(alpha-alpha0)/alpha0;
  let altScore = 0.30*S_atoms + 0.15*S_stars + 0.25*S_cosmos + 0.30*(altSolvOK?S_solvent:0);
  if(alphaDev>0.5) altScore *= 0.6;
  altScore = Math.round(clamp(altScore, 0, 100));

  function tag(score, carbon=false){
    if(score>=70) return {txt: (carbon?'Carbono plaus√≠vel üå±':'Alternativa plaus√≠vel ‚ö°'), cls:'ok'};
    if(score>=40) return {txt: 'Marginal / incerta ‚ö†Ô∏è', cls:'warn'};
    return {txt:'Improv√°vel ‚ùå', cls:'bad'};
  }
  const carbonTag = tag(carbonScore,true);
  const altTag    = tag(altScore,false);

  const diag = [];
  if(atc.notes.length) diag.push(...atc.notes);
  if(st.notes.length)  diag.push(...st.notes);
  if(!env.ok) diag.push(`Solvente fora da faixa: ${env.msg}.`);
  if(cosStatic.notes.length) diag.push(...cosStatic.notes);
  if(diag.length===0) diag.push("Par√¢metros coerentes; qu√≠mica, cosmologia e ambiente plaus√≠veis.");

  return {
    subs: {S_atoms,S_stars,S_cosmos,S_solvent},
    carbon: {score:carbonScore, ...carbonTag},
    alt:    {score:altScore,    ...altTag},
    diag,
    cosmo:{t:integ.t, a:integ.a, t_rm, t_mL, tWin, cosScore}
  };
}


// === Helpers de UI que estavam faltando ===
function classifyPill(el, info){
  // limpa classes e aplica o status
  el.className = 'pill';
  if (info.cls === 'ok')   el.classList.add('ok');
  else if (info.cls === 'warn') el.classList.add('warn');
  else                     el.classList.add('bad');

  // r√≥tulo amig√°vel
  const label = (el.id === 'lifeC') ? 'Carbono' : 'Vida alternativa';
  el.textContent = `${label}: ${info.txt} ‚Äî ${info.score}/100`;
}

function renderMolecules(mod){
  const cont = document.getElementById('molecules');
  if(!cont) return;
  cont.innerHTML = '';
  ['H2','H2O','CO2','NH3','CH4'].forEach(k=>{
    const it = mod[k];
    const div = document.createElement('div');
    div.className = `mol ${it.cls}`;
    div.textContent = `${k} ‚Äî ${it.txt}`;
    cont.appendChild(div);
  });
}



/* ========= Charts ========= */
let chartComp, chartAT;
function renderComponents(subs){
  const ctx = document.getElementById('chartComponents').getContext?.('2d');
  if(!ctx || !window.Chart) return;
  const data = {
    labels:['Qu√≠mica/√Åtomos','Estrelas (G)','Cosmologia','Solvente/UV'],
    datasets:[{
      label:'Componentes',
      data:[subs.S_atoms, subs.S_stars, subs.S_cosmos, subs.S_solvent],
      borderColor:getVar('--blue'),
      backgroundColor:'transparent',
      pointRadius:3,
      tension:.18
    }]
  };
  const opts = {
    responsive:true, maintainAspectRatio:false,
    scales:{
      y:{min:0,max:100, ticks:{color:getVar('--muted')},
         title:{display:true,text:'0‚Äì100',color:getVar('--muted')}},
      x:{ticks:{color:getVar('--muted')}}
    },
    plugins:{legend:{labels:{color:getVar('--fg')}}}
  };
  if(chartComp) chartComp.destroy();
  chartComp = new Chart(ctx, {type:'line', data, options:opts});
}

/* Gr√°fico a(t) com linhas verticais e legenda */
function renderAT(cosmo, marks){
  const ctx = document.getElementById('chartAT').getContext?.('2d');
  if(!ctx || !window.Chart) return;

  const tMax = cosmo.t[cosmo.t.length-1] ?? 14;
  const showRocky = !!(marks && marks.rockyPossible && marks.tFirstRocky != null && marks.tFirstRocky > 0 && marks.tFirstRocky < tMax);
  const showEarth = !!(marks && marks.earthLikePossible && marks.tEarthLike   != null && marks.tEarthLike   > 0 && marks.tEarthLike   < tMax);
  const showLife  = !!(marks && marks.lifePossible      && marks.tLife        != null && marks.tLife        > 0 && marks.tLife        < tMax);

  const datasets = [{
    label:'a(t) (normalizado)',
    data: cosmo.a,
    borderColor:getVar('--green'),
    backgroundColor:'transparent',
    pointRadius:0,
    tension:.12
  },
  // datasets "fantasmas" para aparecerem na legenda
  { label:'‚è±Ô∏è primeiros rochosos', data:[null], borderColor:getVar('--blue'),   borderWidth:2, borderDash:[6,4], pointRadius:0 },
  { label:'üåç Terra-like',          data:[null], borderColor:getVar('--violet'), borderWidth:2, borderDash:[6,4], pointRadius:0 },
  { label:'üß¨ vida plaus√≠vel',      data:[null], borderColor:getVar('--amber'),  borderWidth:2, borderDash:[6,4], pointRadius:0 }];

  const markerPlugin = [{
    id: 'markers',
    afterDraw(chart){
      const {ctx, scales:{x,y}} = chart;
      ctx.save(); ctx.setLineDash([6,4]); ctx.lineWidth=1;
      function vline(t, color){
        const xp = x.getPixelForValue(t); if(!isFinite(xp)) return;
        ctx.strokeStyle = color; ctx.beginPath(); ctx.moveTo(xp, y.top); ctx.lineTo(xp, y.bottom); ctx.stroke();
      }
      if(showRocky) vline(marks.tFirstRocky, getVar('--blue'));
      if(showEarth) vline(marks.tEarthLike,  getVar('--violet'));
      if(showLife)  vline(marks.tLife,       getVar('--amber'));
      ctx.restore();
    }
  }];

  const options = {
    responsive:true, maintainAspectRatio:false,
    scales:{
      x:{title:{display:true,text:'Tempo (Gyr)',color:getVar('--muted')}, ticks:{color:getVar('--muted')}},
      y:{title:{display:true,text:'a(t)',color:getVar('--muted')}, min:0,  ticks:{color:getVar('--muted')}}
    },
    plugins:{legend:{labels:{color:getVar('--fg')}}}
  };

  if(chartAT) chartAT.destroy();
  chartAT = new Chart(ctx, {type:'line', data:{labels: cosmo.t, datasets}, options, plugins:markerPlugin});
}

/* ========= Estado/Leitura ========= */
function currentParams(applyNoiseBias=true){
  const targets = { alpha:0.00729735, mu:1/1836.152673, dMnp:1.293, strong:1.0, Gscale:1.0,
                    Om:0.30, Or:0.0001, OL:0.70, age:14, T:288, P:1.0, uv:1.0 };
  const noise = clamp(readFlo('#rng')||0,0,100);
  const bias  = clamp(readFlo('#bias')||0,0,100);
  let alpha = readFlo('#alpha');
  let mu    = readFlo('#mu');
  let dMnp  = readFlo('#dMnp');
  let strong= readFlo('#strong');
  let Gs    = readFlo('#Gscale');
  let Om    = readFlo('#Om');
  let Or    = readFlo('#Or');
  let OL    = readFlo('#OL');
  let age   = readFlo('#age');
  let T     = readFlo('#T');
  let P     = readFlo('#P');
  let solvent = document.getElementById('solvent').value;
  let uv    = readFlo('#uv');
  let tight = clamp(readFlo('#tight')||0.7,0,1);

  if(applyNoiseBias){
    alpha = nudge(alpha, targets.alpha, noise, bias);
    mu    = nudge(mu,    targets.mu,    noise, bias);
    dMnp  = nudge(dMnp,  targets.dMnp,  noise, bias);
    strong= nudge(strong,targets.strong,noise, bias);
    Gs    = nudge(Gs,    targets.Gscale,noise, bias);
    Om    = nudge(Om,    targets.Om,    noise, bias);
    Or    = nudge(Or,    targets.Or,    noise, bias);
    OL    = nudge(OL,    targets.OL,    noise, bias);
    age   = nudge(age,   targets.age,   noise, bias);
    T     = nudge(T,     targets.T,     noise, bias);
    P     = nudge(P,     targets.P,     noise, bias);
    uv    = nudge(uv,    targets.uv,    noise, bias);
  }

  const Ok = 1 - (Om+Or+OL);
  setTxt('#okShow', Ok.toFixed(6).replace('.',','));

  return {alpha,mu,dMnp,strong,Gscale:Gs,Om,Or,OL,age,T,P,solvent,uv,tight};
}

/* ========= Compartilhar estado ========= */
function encodeState(){
  const ids=['alpha','mu','dMnp','strong','Gscale','Om','Or','OL','H0','age','T','P','solvent','uv','rng','bias','tight'];
  const s={}; ids.forEach(id=> s[id]=document.getElementById(id).value);
  return encodeURIComponent(JSON.stringify(s));
}
function decodeState(q){
  try{
    const s = JSON.parse(decodeURIComponent(q));
    for(const k in s){ const el = document.getElementById(k); if(el) el.value = s[k]; }
  }catch(e){}
}
document.getElementById('btnShare').addEventListener('click', ()=>{
  const url = `${location.origin}${location.pathname}#${encodeState()}`;
  navigator.clipboard?.writeText(url);
  alert('Link copiado! Cole para compartilhar seu cen√°rio.');
});

/* ========= Heatmap Œ±√óG ========= */
function colorForScore(score){
  const h = (120*clamp(score,0,100))/100; // 0..120 (vermelho->verde)
  return `hsl(${h}deg 80% 50%)`;
}
function drawHeatmap(){
  const cvs = document.getElementById('heat'); const ctx = cvs.getContext('2d');
  const dpr = window.devicePixelRatio||1;
  const W = Math.floor(cvs.clientWidth*dpr), H = Math.floor(cvs.clientHeight*dpr);
  cvs.width=W; cvs.height=H;
  ctx.fillStyle = getVar('--card'); ctx.fillRect(0,0,W,H);

  const aMin=0.005, aMax=0.010;
  const gMin=0.3,   gMax=2.0;
  const N = clamp(parseInt(document.getElementById('res').value||50), 10, 120);

  const base = currentParams(false);
  const mode = document.getElementById('mapMode').value;

  const mL=60, mR=20, mT=20, mB=50;
  const plotW=W-mL-mR, plotH=H-mT-mB;

  for(let yi=0; yi<N; yi++){
    for(let xi=0; xi<N; xi++){
      const a = aMin + (xi/(N-1))*(aMax-aMin);
      const g = gMin + ( (N-1-yi)/(N-1) )*(gMax-gMin);
      const p = {...base, alpha:a, Gscale:g};
      const res = evaluateAll(p);
      const s = (mode==='carbon')? res.carbon.score : res.alt.score;
      ctx.fillStyle = colorForScore(s);
      const x = mL + Math.floor( (xi/N)*plotW );
      const y = mT + Math.floor( (yi/N)*plotH );
      const w = Math.ceil(plotW/N)+1;
      const h = Math.ceil(plotH/N)+1;
      ctx.fillRect(x,y,w,h);
    }
  }

  ctx.strokeStyle = getVar('--border'); ctx.lineWidth = 1*dpr;
  ctx.beginPath(); ctx.moveTo(mL, mT); ctx.lineTo(mL, mT+plotH); ctx.lineTo(mL+plotW, mT+plotH); ctx.stroke();

  ctx.fillStyle = getVar('--muted'); ctx.font = `${12*dpr}px system-ui, sans-serif`;
  ctx.textAlign='center'; ctx.fillText('Œ± (estrutura fina)', mL+plotW/2, H-14*dpr);
  ctx.save(); ctx.translate(14*dpr, mT+plotH/2); ctx.rotate(-Math.PI/2); ctx.fillText('G (escala relativa)', 0, 0); ctx.restore();

  ctx.textAlign='center';
  for(let i=0;i<=3;i++){ const x = mL + i*(plotW/3); const a = aMin + i*(aMax-aMin)/3; ctx.fillText(a.toFixed(5), x, mT+plotH+16*dpr); }
  ctx.textAlign='right';
  for(let i=0;i<=3;i++){ const y = mT + plotH - i*(plotH/3); const g = gMin + i*(gMax-gMin)/3; ctx.fillText(g.toFixed(2), mL-6*dpr, y+4*dpr); }

  cvs.onclick = (ev)=>{
    const rect = cvs.getBoundingClientRect();
    const px = (ev.clientX - rect.left) * (dpr);
    const py = (ev.clientY - rect.top)  * (dpr);
    if(px<mL || px>mL+plotW || py<mT || py>mT+plotH) return;
    const xi = (px-mL)/plotW;
    const yi = 1 - (py-mT)/plotH;
    const a = aMin + xi*(aMax-aMin);
    const g = gMin + yi*(gMax-gMin);
    document.getElementById('alpha').value = a.toFixed(6);
    document.getElementById('Gscale').value = g.toFixed(3);
    run();
    document.getElementById('heatInfo').textContent = `Œ±=${a.toFixed(6)} ‚Ä¢ G=${g.toFixed(3)} ‚Ä¢ aplicado`;
  };
}

/* ========= Execu√ß√£o principal ========= */
function run(){
  const p = currentParams(true);
  const res = evaluateAll(p);

  setTxt('#cosmoChk', res.subs.S_cosmos>=67?'OK':'Limita√ß√µes (veja diagn√≥stico)');

  // Tempos cosmol√≥gicos (igualdades)
  setTxt('#tRM',  res.cosmo.t_rm!=null? (res.cosmo.t_rm.toFixed(2).replace('.',',')+' Gyr'):'‚Äî');
  setTxt('#tML',  res.cosmo.t_mL!=null? (res.cosmo.t_mL.toFixed(2).replace('.',',')+' Gyr'):'‚Äî');
  setTxt('#tWin', res.cosmo.tWin!=null? (res.cosmo.tWin.toFixed(2).replace('.',',')+' Gyr'):'‚Äî');

  // Subscores & selos
  classifyPill(document.getElementById('lifeC'), res.carbon);
  classifyPill(document.getElementById('lifeAlt'), res.alt);

  // Mol√©culas
  const env = solventWindow(document.getElementById('solvent').value, readFlo('#T'), readFlo('#P'));
  const mol = moleculesAssessment(p.alpha, p.mu, p.strong, env, p.tight);
  renderMolecules(mol);

  // Estimar tempos de rochosos / Terra-like / vida
  const marks = estimateTimes(p, res.cosmo, atomicChemScores(p.alpha,p.mu,p.dMnp,p.strong,p.tight), stellarScore(p.Gscale,p.tight), env, res.cosmo.cosScore);

  setTxt('#tRock', marks.tFirstRocky!=null ? (marks.rockyPossible? (marks.tFirstRocky.toFixed(2).replace('.',',')+' Gyr') : 'n√£o alcan√ßado') : '‚Äî');
  setTxt('#tEarth', marks.tEarthLike!=null ? (marks.earthLikePossible? (marks.tEarthLike.toFixed(2).replace('.',',')+' Gyr') : 'n√£o alcan√ßado') : '‚Äî');
  setTxt('#tLife',  marks.tLife!=null ? (marks.lifePossible? (marks.tLife.toFixed(2).replace('.',',')+' Gyr') : 'n√£o alcan√ßada') : (env.ok? '‚Äî' : 'solvente inv√°lido'));

  // Diagn√≥stico
  const d = document.getElementById('diag'); d.innerHTML='';
  const diag = [...res.diag];
  if(marks.reason) diag.push(marks.reason);
  diag.forEach(msg=>{ const a=document.createElement('div'); a.textContent='‚Ä¢ '+msg; d.appendChild(a); });

  // Gr√°ficos
  renderComponents(res.subs);
  renderAT(res.cosmo, marks);
}

document.getElementById('btnRun').addEventListener('click', run);
['alpha','mu','dMnp','strong','Gscale','Om','Or','OL','H0','age','T','P','solvent','uv','rng','bias','tight','res','mapMode']
  .forEach(id=> document.getElementById(id).addEventListener('input', ()=>{}));

if(location.hash?.length>1){ decodeState(location.hash.slice(1)); }
setTimeout(()=>{ run(); }, 20);
document.getElementById('btnHeat').addEventListener('click', drawHeatmap);
setTimeout(drawHeatmap, 50);
</script>
</body>
</html>
