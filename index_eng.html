<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Universe Simulator ‚Äî Life (Carbon & Alternatives) + Œ±√óG Heatmap + Friedmann</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<meta name="description" content="Educational universe simulator: carbon-based and alternative life, Œ±√óG heatmap, essential molecules, cosmology with Friedmann.">
<style>
  :root{
    --bg:#0f1117; --fg:#e6e6eb; --muted:#9aa0a6;
    --card:#151924; --border:#2a2f3b;
    --blue:#6c90ff; --red:#ff6b6b; --green:#10b981; --amber:#f59e0b; --violet:#a78bfa;
  }
  [data-theme="light"]{
    --bg:#f7f8fb; --fg:#14161c; --muted:#4b5563;
    --card:#ffffff; --border:#e5e7eb;
    --blue:#3853d8; --red:#d43f3f; --green:#0c8d6a; --amber:#b27208; --violet:#6b46c1;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--border);padding:.9rem 1rem;display:flex;gap:.75rem;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:clamp(1rem,2.4vw,1.25rem)}
  nav a{color:var(--fg);text-decoration:none}
  .btn{border:1px solid var(--border);background:transparent;color:var(--fg);padding:.5rem .8rem;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
  .btn:active{transform:translateY(1px)}
  main{max-width:1250px;margin:1rem auto;padding:0 1rem}
  .grid{display:grid;gap:1rem;grid-template-columns:1fr}
  @media (min-width:1024px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem}
  .legend{font-weight:700;margin-bottom:.6rem;display:flex;gap:.5rem;align-items:center}
  .muted{color:var(--muted);font-size:.9rem}
  .split{display:grid;gap:.75rem;grid-template-columns:1fr}
  @media (min-width:640px){ .split{grid-template-columns:1fr 1fr} }
  label{display:flex;justify-content:space-between;align-items:center;gap:.75rem;margin:.45rem 0}
  input[type="number"], select{
    width:140px;padding:.45rem .6rem;border-radius:10px;border:1px solid var(--border);
    background:transparent;color:var(--fg)
  }
  .row{display:flex;flex-wrap:wrap;gap:.5rem}
  .pill{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--border);padding:.25rem .55rem;border-radius:999px}
  .ok{background:color-mix(in srgb,var(--green) 22%, transparent)}
  .warn{background:color-mix(in srgb,var(--amber) 22%, transparent)}
  .bad{background:color-mix(in srgb,var(--red) 22%, transparent)}
  .box{display:grid;grid-template-columns:auto 1fr;gap:.3rem .75rem;font-size:.92rem}
  .k{color:var(--muted)}
  canvas{background:var(--card);border:1px solid var(--border);border-radius:14px}
  .title{font-weight:700;margin:.2rem 0 .6rem}
  .hr{height:1px;background:var(--border);margin:.6rem 0}
  .notice{font-size:.85rem;border-left:3px solid var(--violet);padding:.5rem .75rem;background:color-mix(in srgb,var(--violet) 12%, transparent);border-radius:8px}
  .molecules{display:flex;flex-wrap:wrap;gap:.4rem}
  .mol{border:1px solid var(--border);border-radius:10px;padding:.35rem .55rem;font-size:.9rem}
  .mol.ok{background:color-mix(in srgb,var(--green) 18%, transparent)}
  .mol.mid{background:color-mix(in srgb,var(--amber) 18%, transparent)}
  .mol.bad{background:color-mix(in srgb,var(--red) 18%, transparent)}
  .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;margin:.5rem 0}
  .small{font-size:.85rem}
  footer{max-width:1250px;margin:2rem auto 1.5rem;padding:0 1rem;color:var(--muted)}
  footer .about{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem}
</style>
</head>
<body>
<header>
  <h1>Universe Simulator ‚Äî Life: Carbon & Alternatives</h1>
  <nav class="row">
    <a class="btn" href="README_EN.md" target="_blank" rel="noopener">üìò Guide (README)</a>
    <a class="btn" href="https://github.com/MarceloFortram/universos" target="_blank" rel="noopener">üß≠ Repository</a>
    <a class="btn" href="index.html" rel="noopener">üáßüá∑ Portugu√™s</a>
    <button id="btnTheme" class="btn" type="button">üåó Theme</button>
    <button id="btnShare" class="btn" type="button">üîó Share</button>
    <button id="btnRun" class="btn primary" type="button">‚ñ∂Ô∏è Evaluate</button>
  </nav>
</header>

<main>
  <!-- (1) CONSTANTS -->
  <section class="grid">
    <div class="card">
      <div class="legend">1) Fundamental constants (fine-tuning)</div>
      <div class="split">
        <div>
          <label title="Fine-structure constant (Œ± ‚âà 1/137)">
            <span>Œ± (fine-structure)</span>
            <input id="alpha" type="number" step="0.00001" value="0.007297" />
          </label>
          <label title="Electron-to-proton mass ratio (‚âà 1/1836)">
            <span>Œº = m‚Çë/m‚Çö</span>
            <input id="mu" type="number" step="0.00001" value="0.0005446" />
          </label>
          <label title="Neutron‚Äìproton mass difference (MeV) ‚âà 1.293">
            <span>Œî(m‚Çô‚àím‚Çö) [MeV]</span>
            <input id="dMnp" type="number" step="0.001" value="1.293" />
          </label>
          <label title="Effective strong force scale (1 = ours)">
            <span>Strong force (x)</span>
            <input id="strong" type="number" step="0.01" value="1.00" />
          </label>
          <label title="Effective gravity scale (1 = ours)">
            <span>Gravity G (x)</span>
            <input id="Gscale" type="number" step="0.01" value="1.00" />
          </label>
        </div>
        <div>
          <label title="Random variation applied to inputs">
            <span>Chance (noise) %</span>
            <input id="rng" type="number" step="1" value="0" />
          </label>
          <label title="Pulls values toward the habitable range (educational meta-parameter)">
            <span>Directionality (‚ÄúGod‚Äù) %</span>
            <input id="bias" type="number" step="1" value="0" />
          </label>
          <label title="How narrow the fine-tuning windows are (0 = tolerant, 1 = very strict)">
            <span>Sensitivity (0‚Äì1)</span>
            <input id="tight" type="number" step="0.05" value="0.7" />
          </label>
          <div class="notice">
            These windows are <b>plausible heuristics</b> for teaching. They do not replace ab-initio quantum chemistry.
          </div>
        </div>
      </div>
    </div>

    <!-- (2) COSMOLOGY + FRIEDMANN -->
    <div class="card">
      <div class="legend">2) Minimal cosmology + Friedmann</div>
      <div class="split">
        <div>
          <label><span>Œ©m (matter)</span><input id="Om" type="number" step="0.01" value="0.30"/></label>
          <label><span>Œ©r (radiation)</span><input id="Or" type="number" step="0.0001" value="0.0001"/></label>
          <label><span>Œ©Œõ (dark energy)</span><input id="OL" type="number" step="0.01" value="0.70"/></label>
          <label><span>H‚ÇÄ (km/s/Mpc)</span><input id="H0" type="number" step="1" value="70"/></label>
        </div>
        <div>
          <label title="Effective usable time for chemistry/evolution">
            <span>Available time (Gyr)</span>
            <input id="age" type="number" step="0.5" value="14"/>
          </label>
          <div class="box" style="margin-top:.4rem">
            <div class="k">Œ©k (curvature)</div><div id="okShow">‚Äî</div>
            <div class="k">Cosmology checks</div><div id="cosmoChk">‚Äî</div>
            <div class="k">t(rad=mat)</div><div id="tRM">‚Äî</div>
            <div class="k">t(Œõ dominates)</div><div id="tML">‚Äî</div>
            <div class="k">Structure window</div><div id="tWin">‚Äî</div>
          </div>
          <div class="muted small" style="margin-top:.4rem">
            RK4 integration of Friedmann: \( \dot a = a H(a) \), with \( H(a)=H_0\sqrt{\Omega_r a^{-4}+\Omega_m a^{-3}+\Omega_k a^{-2}+\Omega_\Lambda} \).
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- (3) ENVIRONMENT -->
  <section class="grid">
    <div class="card">
      <div class="legend">3) Planetary environment</div>
      <div class="split">
        <div>
          <label><span>Surface temperature (K)</span><input id="T" type="number" step="1" value="288"/></label>
          <label><span>Surface pressure (bar)</span><input id="P" type="number" step="0.01" value="1.0"/></label>
          <label>
            <span>Main solvent</span>
            <select id="solvent">
              <option value="H2O">Water (H‚ÇÇO)</option>
              <option value="NH3">Ammonia (NH‚ÇÉ)</option>
              <option value="CH4">Methane (CH‚ÇÑ)</option>
              <option value="C2H6">Ethane (C‚ÇÇH‚ÇÜ)</option>
              <option value="CO2sc">Supercritical CO‚ÇÇ</option>
            </select>
          </label>
          <label title="Ionizing stellar radiation relative to Earth">
            <span>UV/X environment (x)</span><input id="uv" type="number" step="0.1" value="1.0"/>
          </label>
        </div>
        <div>
          <div class="title">Approximate liquid windows (1 bar, reference):</div>
          <div class="box">
            <div class="k">Water</div><div>273‚Äì373 K</div>
            <div class="k">Ammonia</div><div>195‚Äì240 K</div>
            <div class="k">Methane</div><div> 90‚Äì112 K</div>
            <div class="k">Ethane</div><div> 90‚Äì185 K</div>
            <div class="k">CO‚ÇÇ (supercritical)</div><div> T‚â•304 K & P‚â•73 bar</div>
          </div>
          <div class="muted small" style="margin-top:.4rem">
            Ranges shift with pressure; high UV breaks fragile molecules (penalized).
          </div>
        </div>
      </div>
    </div>

    <!-- (4) RESULTS -->
    <div class="card">
      <div class="legend">4) Result & Diagnostics</div>
      <div class="row" style="margin-bottom:.5rem">
        <span id="lifeC" class="pill">Carbon-based: ‚Äî</span>
        <span id="lifeAlt" class="pill">Alternative life: ‚Äî</span>
      </div>
      <div class="box" id="diag"></div>
      <div class="hr"></div>
      <div class="title">Components (0‚Äì100)</div>
      <div style="position:relative;height:320px">
        <canvas id="chartComponents"></canvas>
      </div>
      <div class="muted" style="margin-top:.5rem">
        Subscores: Chemistry/Atoms, Stars (G), Cosmology (with Friedmann), Solvent/UV.
      </div>
    </div>
  </section>

  <!-- (5) MOLECULES + (6) a(t) -->
  <section class="grid" style="margin-top:1rem">
    <div class="card">
      <div class="legend">5) Essential molecules</div>
      <div id="molecules" class="molecules"></div>
      <div class="muted small" style="margin-top:.5rem">
        Qualitative assessments via heuristics (bonding/element production and environment). Educational.
      </div>
    </div>

    <div class="card">
      <div class="legend">6) Detailed cosmology ‚Äî a(t)</div>
      <div style="position:relative;height:320px">
        <canvas id="chartAT"></canvas>
      </div>
      <div class="muted small" style="margin-top:.5rem">
        a(t) normalized so that a(tf)=1; markers for radiation‚Äìmatter equality and matter‚ÄìŒõ when they occur.
      </div>
    </div>
  </section>

  <!-- (7) HEATMAP -->
  <section class="card" style="margin-top:1rem">
    <div class="legend">7) Œ±√óG heatmap ‚Äî Habitability zones</div>
    <div class="toolbar">
      <label class="small"><span style="margin-right:.4rem">Resolution</span>
        <input id="res" type="number" step="5" min="10" max="120" value="50" />
      </label>
      <label class="small"><span style="margin-right:.4rem">Mode</span>
        <select id="mapMode">
          <option value="carbon">Carbon-based</option>
          <option value="alt">Alternative life</option>
        </select>
      </label>
      <button id="btnHeat" type="button" class="btn">üó∫Ô∏è Generate map</button>
      <div class="muted small">Click/tap the map to apply Œ± and G.</div>
    </div>
    <div style="position:relative; height:380px">
      <canvas id="heat" style="width:100%;height:100%;border-radius:12px;border:1px solid var(--border)"></canvas>
      <div id="heatInfo" class="pill" style="position:absolute;left:10px;top:10px">Œ±=‚Äî ‚Ä¢ G=‚Äî ‚Ä¢ score=‚Äî</div>
    </div>
    <div class="muted small" style="margin-top:.5rem">
      X-axis: Œ± (0.005 ‚Üí 0.010). Y-axis: G (0.3 ‚Üí 2.0). Green = better, red = worse.
    </div>
  </section>
</main>

<footer>
  <div class="about">
    <b>About the Author ‚Äî Marcelo Fortran</b><br/>
    Marcelo Fortran is a <i>programming enthusiast</i> and a <i>science-curious</i> maker. This project stems from a desire
    to make ideas from cosmology, chemistry and habitability accessible through an interactive browser simulator.
  </div>
  <div style="margin-top:.6rem">
    üìò Read the full guide at <a href="README_EN.md">README_EN.md</a> ‚Ä¢ üáßüá∑ Vers√£o em portugu√™s: <a href="index.html">index.html</a>
  </div>
</footer>

<script>
/* ========= Theme ========= */
(function(){
  const root = document.documentElement;
  const saved = localStorage.getItem('theme') || 'dark';
  root.setAttribute('data-theme', saved);
  document.getElementById('btnTheme').addEventListener('click', ()=>{
    const now = root.getAttribute('data-theme')==='dark'?'light':'dark';
    root.setAttribute('data-theme', now);
    localStorage.setItem('theme', now);
  });
})();

/* ========= Helpers ========= */
const $ = s=>document.querySelector(s);
function readFlo(id){ return parseFloat($(id).value); }
function setTxt(id, txt){ $(id).textContent = txt; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function rnd(){ return Math.random()*2-1; }

/* ========= Chance & Directionality ========= */
function nudge(value, target, noisePct, biasPct){
  const v = value*(1 + (noisePct/100)*rnd());
  const b = value + (biasPct/100)*(target - value);
  return (noisePct>0 || biasPct>0) ? (0.5*v + 0.5*b) : value;
}

/* ========= Windows (renamed to avoid global conflict) ========= */
function winRange(val, center, relSpan, tight){
  const span = relSpan * (1 - 0.6*tight);
  const lo = center*(1-span), hi = center*(1+span);
  if(val<lo || val>hi) return 0;
  const d = Math.abs((val-center)/(center*span));
  return clamp(1 - d*d, 0, 1);
}

/* ========= Cosmology via Friedmann ========= */
function integrateFriedmann(H0, Om, Or, OL, ageGyr, steps=600){
  const Ok = 1 - (Om+Or+OL);
  const H0_Gyr = H0/978; // ~0.0716 Gyr^-1 for H0=70
  function H_of_a(a){
    const arg = Or/(a**4) + Om/(a**3) + Ok/(a**2) + OL;
    return H0_Gyr * Math.max(0, Math.sqrt(Math.max(0,arg)));
  }
  const dt = ageGyr/steps;
  let a = 1e-4, t=0;
  const T=new Array(steps+1), A=new Array(steps+1);
  for(let i=0;i<=steps;i++){
    T[i]=t; A[i]=a;
    const k1 = H_of_a(a)*a*dt;
    const k2 = H_of_a(a + k1/2)* (a + k1/2) * dt;
    const k3 = H_of_a(a + k2/2)* (a + k2/2) * dt;
    const k4 = H_of_a(a + k3)*   (a + k3)   * dt;
    const da = (k1 + 2*k2 + 2*k3 + k4)/6;
    a = (da>0 && isFinite(da)) ? a + da : a;
    t += dt;
  }
  const norm = A[A.length-1] || 1;
  for(let i=0;i<A.length;i++){ A[i] = A[i]/norm; }
  return {t:T, a:A, Ok};
}
function findTimeAtA(T, A, aTarget){
  if(aTarget==null || aTarget<=0) return null;
  for(let i=1;i<A.length;i++){
    if(A[i-1]<=aTarget && A[i]>=aTarget){
      const u=(aTarget-A[i-1])/(A[i]-A[i-1] + 1e-12);
      return T[i-1]+u*(T[i]-T[i-1]);
    }
  }
  return null;
}

/* ========= Minimal cosmology (static checks) ========= */
function cosmosChecksStatic(Om, Or, OL, ageGyr){
  const Ok = 1 - (Om+Or+OL);
  const hasMatter = Om >= 0.05 ? 1 : 0;
  const lambdaNotTooHigh = OL <= 0.9 ? 1 : 0;
  const ageOK = ageGyr >= 5 ? 1 : 0;
  const score = (hasMatter + lambdaNotTooHigh + ageOK)/3;
  const notes = [];
  if(!hasMatter) notes.push("Insufficient matter to form galaxies.");
  if(!lambdaNotTooHigh) notes.push("Dark energy too high: structures cut off early.");
  if(!ageOK) notes.push("Available time too short (<5 Gyr).");
  return {Ok, score, notes};
}

/* ========= Atomic/nuclear chemistry ========= */
function atomicChemScores(alpha, mu, dMnpMeV, strongScale, tight){
  const alpha0 = 1/137.035999;
  const mu0 = 1/1836.152673;
  const dM0 = 1.293;
  const s0 = 1.0;

  const sAlpha = winRange(alpha, alpha0, 0.18, tight);
  const sMu    = winRange(mu,    mu0,    0.35, tight);
  const sDM    = winRange(dMnpMeV, dM0,  0.45, tight);
  const sStrong= winRange(strongScale, s0, 0.05, tight);

  const notes=[];
  if(sAlpha===0) notes.push("Œ± out of range: unstable electronic bonding.");
  if(sMu===0) notes.push("m‚Çë/m‚Çö out of range: orbitals/chemistry too distorted.");
  if(sDM===0) notes.push("Œî(m‚Çô‚àím‚Çö) out of range: nuclear stability compromised.");
  if(sStrong===0) notes.push("Strong force off fine-tuning: carbon/oxygen suppressed.");

  const atomScore = 0.35*sAlpha + 0.25*sMu + 0.25*sDM + 0.15*sStrong;
  const carbonOK = (sStrong>0.25);

  return { atomScore, carbonOK, notes, pieces:{sAlpha,sMu,sDM,sStrong} };
}

/* ========= Stars (gravity) ========= */
function stellarScore(Gscale, tight){
  const sG = winRange(Gscale, 1.0, 0.5, tight);
  const notes=[];
  if(sG===0 && Gscale>1.0) notes.push("High G: short-lived stars (millions of years).");
  if(sG===0 && Gscale<1.0) notes.push("Low G: nuclear ignition hindered.");
  return { sG, notes };
}

/* ========= Solvents & UV ========= */
function solventWindow(solvent, T, P){
  let ok=0, msg=""; 
  if(solvent==='H2O'){ ok = (T>=273 && T<=373 && P>=0.006) ? 1:0; msg="Liquid water 273‚Äì373 K @ ‚â•0.006 bar"; }
  if(solvent==='NH3'){ ok = (T>=195 && T<=240) ? 1:0; msg="Liquid ammonia 195‚Äì240 K @ ~1 bar"; }
  if(solvent==='CH4'){ ok = (T>=90 && T<=112)  ? 1:0; msg="Liquid methane 90‚Äì112 K @ ~1 bar"; }
  if(solvent==='C2H6'){ ok = (T>=90 && T<=185) ? 1:0; msg="Liquid ethane 90‚Äì185 K @ ~1 bar"; }
  if(solvent==='CO2sc'){ ok = (T>=304 && P>=73) ? 1:0; msg="Supercritical CO‚ÇÇ T‚â•304 K & P‚â•73 bar"; }
  return {ok, msg};
}
function uvPenalty(uv){
  const p = 1/(1+Math.exp(-(2-uv)));
  return clamp(1.2 - 0.2*p, 0.6, 1);
}

/* ========= Essential molecules (heuristic) ========= */
function moleculesAssessment(alpha, mu, strongScale, envOK, tight){
  const alpha0 = 1/137.035999, mu0 = 1/1836.152673;
  const eScale = (alpha/alpha0)**2 * (mu/mu0);
  const prodCO = winRange(strongScale, 1.0, 0.05, tight);
  const prodN  = winRange(strongScale, 1.0, 0.08, tight);
  function status(score){
    if(score>=0.75) return {cls:'ok', txt:'stable'};
    if(score>=0.4)  return {cls:'mid', txt:'marginal'};
    return {cls:'bad', txt:'unstable'};
  }
  const eH2 = 13.6 * eScale;
  const sH2 = clamp( (eH2>5 && eH2<25) ? 0.9 : (eH2>3 && eH2<35 ? 0.5 : 0.0), 0, 1);
  const sCH4 = clamp(0.6*prodCO + 0.4*winRange(eScale, 1.0, 0.7, tight), 0, 1);
  let sH2O = clamp(0.6*prodCO + 0.4*sH2, 0, 1);
  if(envOK && envOK.solvent==='H2O' && envOK.ok) sH2O = clamp(sH2O*1.05, 0, 1);
  const sNH3 = clamp(0.6*prodN + 0.4*sH2, 0, 1);
  const sCO2 = prodCO;
  return {
    H2:  {score:sH2,  ...status(sH2)},
    H2O: {score:sH2O, ...status(sH2O)},
    CH4: {score:sCH4, ...status(sCH4)},
    NH3: {score:sNH3, ...status(sNH3)},
    CO2: {score:sCO2, ...status(sCO2)},
  };
}

/* ========= Aggregation (with Friedmann) ========= */
function evaluateAll(params){
  const {alpha, mu, dMnp, strong, Gscale, Om, Or, OL, age, T, P, solvent, uv, tight} = params;

  const cosStatic = cosmosChecksStatic(Om,Or,OL,age);
  const integ = integrateFriedmann(readFlo('#H0'), Om, Or, OL, age, 600);
  const a_rm = (Or>0 && Om>0)? (Or/Om) : null;
  const a_mL = (OL>0 && Om>0)? Math.pow(Om/OL, 1/3) : null;
  const t_rm = findTimeAtA(integ.t, integ.a, a_rm);
  const t_mL = findTimeAtA(integ.t, integ.a, a_mL);
  let tWin = null;
  if(t_rm!=null && t_mL!=null && t_mL>t_rm){ tWin = t_mL - t_rm; }
  const fracWin = tWin ? clamp(tWin/age, 0, 1) : 0;
  const cosScore = clamp(0.55*cosStatic.score + 0.45*fracWin, 0, 1);
  const cosNotes = [...cosStatic.notes];
  if(t_rm==null) cosNotes.push("Radiation‚Äìmatter equality not reached in integration window.");
  if(t_mL==null) cosNotes.push("Œõ dominance not reached in integration window.");
  if(tWin!=null && tWin<2) cosNotes.push("Structure window is short (<2 Gyr).");

  const atc = atomicChemScores(alpha, mu, dMnp, strong, tight);
  const st  = stellarScore(Gscale, tight);
  const env = solventWindow(solvent, T, P);
  const uvk = uvPenalty(uv);

  const S_atoms   = Math.round(100*atc.atomScore);
  const S_stars   = Math.round(100*st.sG);
  const S_cosmos  = Math.round(100*cosScore);
  const S_solvent = Math.round(100*(env.ok?1:0)*uvk);

  let carbonScore = 0.35*S_atoms + 0.18*S_stars + 0.27*S_cosmos + 0.20*(solvent==='H2O'?S_solvent:0);
  if(!atc.carbonOK) carbonScore = Math.min(carbonScore, 35);
  carbonScore = Math.round(clamp(carbonScore, 0, 100));

  const altSolvOK = (solvent!=='H2O' && env.ok);
  const alpha0 = 1/137.035999;
  const alphaDev = Math.abs(alpha-alpha0)/alpha0;
  let altScore = 0.30*S_atoms + 0.15*S_stars + 0.25*S_cosmos + 0.30*(altSolvOK?S_solvent:0);
  if(alphaDev>0.5) altScore *= 0.6;
  altScore = Math.round(clamp(altScore, 0, 100));

  function tag(score, carbon=false){
    if(score>=70) return {txt: (carbon?'Carbon-based plausible üå±':'Alternative plausible ‚ö°'), cls:'ok'};
    if(score>=40) return {txt: 'Marginal / uncertain ‚ö†Ô∏è', cls:'warn'};
    return {txt:'Unlikely ‚ùå', cls:'bad'};
  }
  const carbonTag = tag(carbonScore,true);
  const altTag    = tag(altScore,false);

  const diag = [];
  if(atc.notes.length) diag.push(...atc.notes);
  if(st.notes.length)  diag.push(...st.notes);
  if(!env.ok) diag.push(`Solvent out of range: ${env.msg}.`);
  if(cosNotes.length) diag.push(...cosNotes);
  if(diag.length===0) diag.push("Parameters consistent; chemistry, cosmology, and environment plausible.");

  return {
    Ok: integ.Ok,
    subs: {S_atoms,S_stars,S_cosmos,S_solvent},
    carbon: {score:carbonScore, ...carbonTag},
    alt:    {score:altScore,    ...altTag},
    diag,
    cosmo:{t:integ.t, a:integ.a, t_rm, t_mL, tWin}
  };
}

/* ========= Charts ========= */
let chartComp, chartAT;
function renderComponents(subs){
  const ctx = document.getElementById('chartComponents').getContext?.('2d');
  if(!ctx || !window.Chart) return;
  const data = {
    labels:['Chemistry/Atoms','Stars (G)','Cosmology','Solvent/UV'],
    datasets:[{
      label:'Components',
      data:[subs.S_atoms, subs.S_stars, subs.S_cosmos, subs.S_solvent],
      borderColor:getComputedStyle(document.documentElement).getPropertyValue('--blue').trim(),
      backgroundColor:'transparent',
      pointRadius:3,
      tension:.18
    }]
  };
  const opts = {
    responsive:true, maintainAspectRatio:false,
    scales:{
      y:{min:0,max:100, ticks:{color:getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()},
         title:{display:true,text:'0‚Äì100',color:getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()}},
      x:{ticks:{color:getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()}}
    },
    plugins:{legend:{labels:{color:getComputedStyle(document.documentElement).getPropertyValue('--fg').trim()}}}
  };
  if(chartComp) chartComp.destroy();
  chartComp = new Chart(ctx, {type:'line', data, options:opts});
}
function renderAT(cosmo){
  const ctx = document.getElementById('chartAT').getContext?.('2d');
  if(!ctx || !window.Chart) return;
  const data = {
    labels: cosmo.t,
    datasets:[{
      label:'a(t) (normalized)',
      data: cosmo.a,
      borderColor:getComputedStyle(document.documentElement).getPropertyValue('--green').trim(),
      backgroundColor:'transparent',
      pointRadius:0,
      tension:.12
    }]
  };
  const opts = {
    responsive:true, maintainAspectRatio:false,
    scales:{
      x:{title:{display:true,text:'Time (Gyr)',color:getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()},
         ticks:{color:getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()}},
      y:{title:{display:true,text:'a(t)',color:getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()},
         min:0, ticks:{color:getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()}}
    },
    plugins:{legend:{labels:{color:getComputedStyle(document.documentElement).getPropertyValue('--fg').trim()}}}
  };
  if(chartAT) chartAT.destroy();
  chartAT = new Chart(ctx, {type:'line', data, options:opts});
}

/* ========= UI Helpers ========= */
function classifyPill(el, info){
  el.className='pill';
  if(info.cls==='ok') el.classList.add('ok');
  if(info.cls==='warn') el.classList.add('warn');
  if(info.cls==='bad') el.classList.add('bad');
  el.textContent = `${el.id==='lifeC'?'Carbon-based':'Alternative life'}: ${info.txt} ‚Äî ${info.score}/100`;
}
function renderMolecules(mod){
  const cont = document.getElementById('molecules'); cont.innerHTML='';
  for(const k of ['H2','H2O','CO2','NH3','CH4']){
    const it = mod[k];
    const div=document.createElement('div');
    div.className = `mol ${it.cls}`;
    div.textContent = `${k} ‚Äî ${it.txt}`;
    cont.appendChild(div);
  }
}

/* ========= State/Reading ========= */
function currentParams(applyNoiseBias=true){
  const targets = { alpha:0.00729735, mu:1/1836.152673, dMnp:1.293, strong:1.0, Gscale:1.0,
                    Om:0.30, Or:0.0001, OL:0.70, age:14, T:288, P:1.0, uv:1.0 };
  const noise = clamp(readFlo('#rng'),0,100);
  const bias  = clamp(readFlo('#bias'),0,100);
  let alpha = readFlo('#alpha');
  let mu    = readFlo('#mu');
  let dMnp  = readFlo('#dMnp');
  let strong= readFlo('#strong');
  let Gs    = readFlo('#Gscale');
  let Om    = readFlo('#Om');
  let Or    = readFlo('#Or');
  let OL    = readFlo('#OL');
  let age   = readFlo('#age');
  let T     = readFlo('#T');
  let P     = readFlo('#P');
  let solvent = document.getElementById('solvent').value;
  let uv    = readFlo('#uv');
  let tight = clamp(readFlo('#tight'),0,1);

  if(applyNoiseBias){
    alpha = nudge(alpha, targets.alpha, noise, bias);
    mu    = nudge(mu,    targets.mu,    noise, bias);
    dMnp  = nudge(dMnp,  targets.dMnp,  noise, bias);
    strong= nudge(strong,targets.strong,noise, bias);
    Gs    = nudge(Gs,    targets.Gscale,noise, bias);
    Om    = nudge(Om,    targets.Om,    noise, bias);
    Or    = nudge(Or,    targets.Or,    noise, bias);
    OL    = nudge(OL,    targets.OL,    noise, bias);
    age   = nudge(age,   targets.age,   noise, bias);
    T     = nudge(T,     targets.T,     noise, bias);
    P     = nudge(P,     targets.P,     noise, bias);
    uv    = nudge(uv,    targets.uv,    noise, bias);
  }

  const Ok = 1 - (Om+Or+OL);
  setTxt('#okShow', Ok.toFixed(6));

  return {alpha,mu,dMnp,strong,Gscale:Gs,Om,Or,OL,age,T,P,solvent,uv,tight};
}

/* ========= Run evaluation ========= */
function run(){
  const p = currentParams(true);
  const res = evaluateAll(p);

  setTxt('#cosmoChk', res.subs.S_cosmos>=67?'OK':'Limitations (see diagnostics)');
  setTxt('#tRM', res.cosmo.t_rm!=null? (res.cosmo.t_rm.toFixed(2)+' Gyr'):'‚Äî');
  setTxt('#tML', res.cosmo.t_mL!=null? (res.cosmo.t_mL.toFixed(2)+' Gyr'):'‚Äî');
  setTxt('#tWin', res.cosmo.tWin!=null? (res.cosmo.tWin.toFixed(2)+' Gyr'):'‚Äî');

  classifyPill(document.getElementById('lifeC'), res.carbon);
  classifyPill(document.getElementById('lifeAlt'), res.alt);

  const d = document.getElementById('diag'); d.innerHTML='';
  res.diag.forEach(msg=>{ const a=document.createElement('div'); a.textContent='‚Ä¢ '+msg; d.appendChild(a); });

  renderComponents(res.subs);
  renderAT(res.cosmo);

  const env = solventWindow(document.getElementById('solvent').value, readFlo('#T'), readFlo('#P'));
  const mol = moleculesAssessment(p.alpha, p.mu, p.strong, {ok:env.ok, solvent:document.getElementById('solvent').value}, p.tight);
  renderMolecules(mol);
}

/* ========= Share state ========= */
function encodeState(){
  const ids=['alpha','mu','dMnp','strong','Gscale','Om','Or','OL','H0','age','T','P','solvent','uv','rng','bias','tight'];
  const s={}; ids.forEach(id=> s[id]=document.getElementById(id).value);
  return encodeURIComponent(JSON.stringify(s));
}
function decodeState(q){
  try{
    const s = JSON.parse(decodeURIComponent(q));
    for(const k in s){ const el = document.getElementById(k); if(el) el.value = s[k]; }
  }catch(e){}
}
document.getElementById('btnShare').addEventListener('click', ()=>{
  const url = `${location.origin}${location.pathname}#${encodeState()}`;
  navigator.clipboard?.writeText(url);
  alert('Link copied! Paste it to share your scenario.');
});
if(location.hash?.length>1){ decodeState(location.hash.slice(1)); }

/* ========= Œ±√óG Heatmap ========= */
function colorForScore(score){
  const h = (120*clamp(score,0,100))/100; // 0..120 (red->green)
  return `hsl(${h}deg 80% 50%)`;
}
function drawHeatmap(){
  const cvs = document.getElementById('heat'); const ctx = cvs.getContext('2d');
  const dpr = window.devicePixelRatio||1;
  const W = Math.floor(cvs.clientWidth*dpr), H = Math.floor(cvs.clientHeight*dpr);
  cvs.width=W; cvs.height=H;
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card').trim();
  ctx.fillRect(0,0,W,H);
  const aMin=0.005, aMax=0.010;
  const gMin=0.3,   gMax=2.0;
  const N = clamp(parseInt(document.getElementById('res').value||50), 10, 120);
  const base = currentParams(false);
  const mode = document.getElementById('mapMode').value;
  const mL=60, mR=20, mT=20, mB=50;
  const plotW=W-mL-mR, plotH=H-mT-mB;
  for(let yi=0; yi<N; yi++){
    for(let xi=0; xi<N; xi++){
      const a = aMin + (xi/(N-1))*(aMax-aMin);
      const g = gMin + ( (N-1-yi)/(N-1) )*(gMax-gMin);
      const p = {...base, alpha:a, Gscale:g};
      const res = evaluateAll(p);
      const s = (mode==='carbon')? res.carbon.score : res.alt.score;
      ctx.fillStyle = colorForScore(s);
      const x = mL + Math.floor( (xi/N)*plotW );
      const y = mT + Math.floor( (yi/N)*plotH );
      const w = Math.ceil(plotW/N)+1;
      const h = Math.ceil(plotH/N)+1;
      ctx.fillRect(x,y,w,h);
    }
  }
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
  ctx.lineWidth = 1*dpr;
  ctx.beginPath(); ctx.moveTo(mL, mT); ctx.lineTo(mL, mT+plotH); ctx.lineTo(mL+plotW, mT+plotH); ctx.stroke();
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim();
  ctx.font = `${12*dpr}px system-ui, sans-serif`;
  ctx.textAlign='center'; ctx.fillText('Œ± (fine-structure)', mL+plotW/2, H-14*dpr);
  ctx.save(); ctx.translate(14*dpr, mT+plotH/2); ctx.rotate(-Math.PI/2);
  ctx.fillText('G (relative scale)', 0, 0); ctx.restore();
  ctx.textAlign='center';
  for(let i=0;i<=3;i++){
    const x = mL + i*(plotW/3);
    const a = aMin + i*(aMax-aMin)/3;
    ctx.fillText(a.toFixed(5), x, mT+plotH+16*dpr);
  }
  ctx.textAlign='right';
  for(let i=0;i<=3;i++){
    const y = mT + plotH - i*(plotH/3);
    const g = gMin + i*(gMax-gMin)/3;
    ctx.fillText(g.toFixed(2), mL-6*dpr, y+4*dpr);
  }
  cvs.onclick = (ev)=>{
    const rect = cvs.getBoundingClientRect();
    const px = (ev.clientX - rect.left) * (dpr);
    const py = (ev.clientY - rect.top)  * (dpr);
    if(px<mL || px>mL+plotW || py<mT || py>mT+plotH) return;
    const xi = (px-mL)/plotW;
    const yi = 1 - (py-mT)/plotH;
    const a = aMin + xi*(aMax-aMin);
    const g = gMin + yi*(gMax-gMin);
    document.getElementById('alpha').value = a.toFixed(6);
    document.getElementById('Gscale').value = g.toFixed(3);
    run();
    document.getElementById('heatInfo').textContent = `Œ±=${a.toFixed(6)} ‚Ä¢ G=${g.toFixed(3)} ‚Ä¢ applied`;
  };
}
document.getElementById('btnHeat').addEventListener('click', drawHeatmap);

/* ========= Events ========= */
document.getElementById('btnRun').addEventListener('click', run);
['alpha','mu','dMnp','strong','Gscale','Om','Or','OL','H0','age','T','P','solvent','uv','rng','bias','tight','res','mapMode']
  .forEach(id=> document.getElementById(id).addEventListener('input', ()=>{}));

if(location.hash?.length>1){ decodeState(location.hash.slice(1)); }
run();
setTimeout(drawHeatmap, 30);
</script>
</body>
</html>
